#include <iostream>   // Подключение библиотеки для ввода и вывода
#include <random>     // Подключение библиотеки для генерации случайных чисел
#include <chrono>     // Подключение библиотеки для измерения времени
#include <omp.h>      // Подключение библиотеки OpenMP
#include <iomanip>    // Подключение библиотеки для форматированного вывода

using namespace std;  // Использование стандартного пространства имён

int task4() { // Функция для выполнения задания 4

    constexpr int SIZE = 5'000'000;       // Размер массива (5 000 000 элементов)
    constexpr int RAND_MIN_VAL = 1;        // Минимальное значение диапазона
    constexpr int RAND_MAX_VAL = 100;      // Максимальное значение диапазона

    int* arr = new int[SIZE];              // Динамическое выделение памяти под массив

    random_device rd;                      // Источник энтропии
    mt19937 gen(rd());                  // Генератор случайных чисел
    uniform_int_distribution<> dist(RAND_MIN_VAL, RAND_MAX_VAL); // Равномерное распределение

    for (int i = 0; i < SIZE; i++) {       // Заполнение массива случайными числами
        arr[i] = dist(gen);             // Генерация и запись значения
    }

    // ======================================================
    // ПОСЛЕДОВАТЕЛЬНОЕ ВЫЧИСЛЕНИЕ СРЕДНЕГО ЗНАЧЕНИЯ
    // ======================================================

    auto start_seq = chrono::high_resolution_clock::now(); // Начало измерения времени (SEQ)

    long long sum_seq = 0;                 // Переменная для хранения суммы (последовательно)

    for (int i = 0; i < SIZE; i++) {       // Последовательный обход массива
        sum_seq += arr[i];                 // Суммирование элементов
    }

    double avg_seq = static_cast<double>(sum_seq) / SIZE; // Вычисление среднего значения

    auto end_seq = chrono::high_resolution_clock::now(); // Конец измерения времени (SEQ)
    chrono::duration<double> time_seq = end_seq - start_seq; // Время выполнения SEQ

    // ======================================================
    // ПАРАЛЛЕЛЬНОЕ ВЫЧИСЛЕНИЕ СРЕДНЕГО ЗНАЧЕНИЯ (OpenMP)
    // ======================================================

    auto start_par = chrono::high_resolution_clock::now(); // Начало измерения времени (OMP)

    long long sum_par = 0;                 // Переменная для хранения суммы (параллельно)

    #pragma omp parallel for reduction(+:sum_par) // Параллельный цикл с редукцией суммы
    for (int i = 0; i < SIZE; i++) {       // Параллельный обход массива
        sum_par += arr[i];                 // Добавление элемента к общей сумме
    }

    double avg_par = static_cast<double>(sum_par) / SIZE; // Вычисление среднего значения

    auto end_par = chrono::high_resolution_clock::now(); // Конец измерения времени (OMP)
    chrono::duration<double> time_par = end_par - start_par; // Время выполнения OMP

    // ======================================================
    // ВЫВОД РЕЗУЛЬТАТОВ
    // ======================================================

    cout << fixed << setprecision(10);     // Установка формата вывода времени

    cout << "Последовательное выполнение." << endl;
    cout << "Среднее значение массива: " << avg_seq << endl; // Вывод среднего (SEQ)
    cout << "Время выполнения: " << time_seq.count() << " секунды\n" << endl;

    cout << "Параллельное выполнение с использованием OpenMP." << endl;
    cout << "Среднее значение массива: " << avg_par << endl; // Вывод среднего (OMP)
    cout << "Время выполнения: " << time_par.count() << " секунды\n" << endl;

    delete[] arr;                          // Освобождение динамически выделенной памяти
    cout << "Динамическая память успешно освобождена." << endl; // Сообщение об освобождении памяти

    return 0;                              // Завершение функции
}

int main() {          // Главная функция программы
    task4();          // Вызов функции задания 4
    return 0;         // Завершение работы программы
}
